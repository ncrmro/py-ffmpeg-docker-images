kind: pipeline
name: default

clone:
  disable: true

environment:
  DOCKER_HOST: tcp://docker-in-docker:2375
  DOCKER_CLI_EXPERIMENTAL: enabled

steps:
- name: clone
  image: alpine/git
  commands:
  - git clone http://gitea.wg/ncrmro/py-ffmpeg-docker-images.git .
  - git checkout $DRONE_COMMIT

- name: Docker Information
  image: docker/compose:alpine-1.26.2
  commands:
  - docker version
  - docker-compose version
  - mkdir -p ~/.docker/cli-plugins
  - wget https://github.com/docker/buildx/releases/download/v0.4.1/buildx-v0.4.1.darwin-amd64
  - mv buildx-v0.4.1.darwin-amd64 ~/.docker/cli-plugins/docker-buildx
  - chmod a+x ~/.docker/cli-plugins/docker-buildx
  - docker buildx version

services:
- name: docker-in-docker
  docker:
  image: docker:19.03.12-dind
  command: ["dockerd", "--host", "0.0.0.0", "--experimental", "--insecure-registry", "registry.wg", "--registry-mirror", "http://registry_cache:5000"]
  privileged: true
